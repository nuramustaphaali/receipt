{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Receipt</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/app.css' %}">
    
    <style>
        /* BASE & LAYOUT */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #0f172a;
        }
        
        .container { max-width: 950px; margin: 40px auto; padding: 20px; }
        .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        h2 { margin-top: 0; color: #1e293b; font-weight: 700; }
        h3 { margin: 0; font-size: 1.1rem; color: #334155; }

        .section-header { 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 15px; 
            margin: 35px 0 20px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        /* GRID SYSTEM */
        .row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .col { flex: 1; min-width: 200px; position: relative; }

        /* --- NEW: FORM ELEMENT STYLING --- */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #475569;
            font-size: 0.9rem;
        }

        /* Target all common input types */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #0f172a;
            background-color: #ffffff;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            box-sizing: border-box; /* Ensures padding doesn't break width */
        }

        /* Focus State (Active) */
        input:focus, select:focus {
            outline: none;
            border-color: #0f172a; /* Dark border on focus */
            box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1); /* Subtle glow */
        }

        /* Date Input Specifics */
        input[type="date"] {
            cursor: pointer;
        }

        /* Select Dropdown Specifics */
        select {
            appearance: none; /* Removes default ugly arrow */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        /* DYNAMIC FORM BLOCKS */
        .dynamic-form { 
            background: #f8fafc; 
            padding: 20px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
            position: relative; 
        }

        /* BUTTONS */
        .btn-add { 
            background: #10b981; 
            color: white; 
            padding: 8px 16px; 
            border-radius: 6px; 
            text-decoration: none; 
            font-size: 0.85rem; 
            font-weight: 600; 
            cursor: pointer; 
            border: none; 
            transition: background 0.2s;
        }
        .btn-add:hover { background: #059669; }

        .btn-save { 
            background: #0f172a; 
            color: white; 
            padding: 16px; 
            font-size: 1rem; 
            font-weight: 600; 
            border-radius: 8px; 
            cursor: pointer; 
            border: none; 
            margin-top: 30px; 
            width: 100%; 
            transition: background 0.2s;
        }
        .btn-save:hover { background: #1e293b; }

        /* CHECKBOXES */
        .delete-checkbox { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            font-size: 0.85rem;
            color: #ef4444; /* Red text for delete */
            background: #fef2f2;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #fecaca;
        }
        .delete-checkbox input {
            width: auto !important; /* Reset width for checkbox */
            margin-left: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>Create New Receipt</h2>
        
        <form method="post">
            {% csrf_token %}

            <div class="section-header">
                <h3>Receipt Details</h3>
            </div>
            <div class="row">
                <div class="col">{{ form.invoice_number.label_tag }} {{ form.invoice_number }}</div>
                <div class="col">{{ form.invoice_date.label_tag }} {{ form.invoice_date }}</div>
            </div>
            <div class="row">
                <div class="col">{{ form.client_name.label_tag }} {{ form.client_name }}</div>
                <div class="col">{{ form.invoice_to.label_tag }} {{ form.invoice_to }}</div>
            </div>
            <div class="row">
                <div class="col">{{ form.status.label_tag }} {{ form.status }}</div>
                <div class="col">{{ form.departure_date.label_tag }} {{ form.departure_date }}</div>
                <div class="col">{{ form.return_date.label_tag }} {{ form.return_date }}</div>
            </div>

            <div class="section-header">
                <h3>Passengers</h3>
                <button type="button" class="btn-add" id="add-passenger"> + Add Passenger</button>
            </div>
            
            {{ passenger_formset.management_form }}
            <div id="passenger-list">
                {% for form in passenger_formset %}
                <div class="dynamic-form passenger-form">
                    {{ form.id }}
                    <div class="row">
                        <div class="col">
                            <label>Full Name:</label>
                            {{ form.full_name }}
                        </div>
                        <div class="col">
                            <label>Date of Birth:</label>
                            {{ form.dob }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Passport Number:</label>
                            {{ form.passport_number }}
                        </div>
                        <div class="col">
                            <label>Gender:</label>
                            {{ form.gender }}
                        </div>
                    </div>
                    {% if passenger_formset.can_delete %}
                        <div class="delete-checkbox">Delete? {{ form.DELETE }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="section-header">
                <h3>Items</h3>
                <button type="button" class="btn-add" id="add-item"> + Add Item</button>
            </div>

            {{ item_formset.management_form }}
            <div id="item-list">
                {% for form in item_formset %}
                <div class="dynamic-form item-form">
                    {{ form.id }}
                    <div class="row">
                        <div class="col" style="flex: 2;">
                            <label>Description:</label>
                            {{ form.description }}
                        </div>
                        <div class="col">
                            <label>Qty:</label>
                            {{ form.quantity }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Unit (e.g. Persons):</label>
                            {{ form.quantity_unit }}
                        </div>
                        <div class="col">
                            <label>Price (NGN):</label>
                            {{ form.unit_price }}
                        </div>
                    </div>
                    {% if item_formset.can_delete %}
                        <div class="delete-checkbox">Delete? {{ form.DELETE }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <button type="submit" class="btn-save">Save & Generate Receipt</button>
        </form>
    </div>
</div>

<div id="empty-passenger" style="display:none">
    <div class="dynamic-form passenger-form">
        <div class="row">
            <div class="col"><label>Name:</label> {{ passenger_formset.empty_form.full_name }}</div>
            <div class="col"><label>DOB:</label> {{ passenger_formset.empty_form.dob }}</div>
        </div>
        <div class="row">
            <div class="col"><label>Passport:</label> {{ passenger_formset.empty_form.passport_number }}</div>
            <div class="col"><label>Gender:</label> {{ passenger_formset.empty_form.gender }}</div>
        </div>
        <div class="delete-checkbox">Delete? {{ passenger_formset.empty_form.DELETE }}</div>
    </div>
</div>

<div id="empty-item" style="display:none">
    <div class="dynamic-form item-form">
        <div class="row">
            <div class="col" style="flex: 2;"><label>Desc:</label> {{ item_formset.empty_form.description }}</div>
            <div class="col"><label>Qty:</label> {{ item_formset.empty_form.quantity }}</div>
        </div>
        <div class="row">
            <div class="col"><label>Unit:</label> {{ item_formset.empty_form.quantity_unit }}</div>
            <div class="col"><label>Price:</label> {{ item_formset.empty_form.unit_price }}</div>
        </div>
        <div class="delete-checkbox">Delete? {{ item_formset.empty_form.DELETE }}</div>
    </div>
</div>

<script>
    function addForm(type) {
        const totalForms = document.getElementById(`id_${type}-TOTAL_FORMS`);
        const currentCount = parseInt(totalForms.value);
        
        const mapping = { 'passengers': 'passenger', 'items': 'item' };
        const singular = mapping[type];
        
        const emptyFormContent = document.getElementById(`empty-${singular}`).innerHTML;
        const newFormHtml = emptyFormContent.replace(/__prefix__/g, currentCount);

        const listDiv = document.getElementById(`${singular}-list`);
        const newDiv = document.createElement('div');
        newDiv.innerHTML = newFormHtml;
        listDiv.appendChild(newDiv);

        totalForms.value = currentCount + 1;
    }

    document.getElementById('add-passenger').addEventListener('click', () => addForm('passengers'));
    document.getElementById('add-item').addEventListener('click', () => addForm('items'));
</script>

</body>
</html>